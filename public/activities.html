<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mes Activités Strava</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f4f4; color: #333; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 800px; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #fc4c02; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        #status { font-size: 1.2em; font-weight: bold; text-align: center; padding: 40px; }
        .activity { border-bottom: 1px solid #eee; padding: 15px 5px; margin-bottom: 10px; }
        #map { height: 400px; width: 100%; border-radius: 8px; margin-top: 20px; background-color: #eee; }
        .chart-container { position: relative; height: 250px; width: 100%; margin-top: 24px; }
        #latest-activity-summary { margin-bottom: 30px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .stat { background-color: #f9f9f9; padding: 20px; border-radius: 8px; text-align: center; border: 1px solid #eee; }
        .stat h3 { margin: 0 0 8px 0; font-size: 0.9em; color: #555; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat p { margin: 0; font-size: 1.8em; font-weight: 600; color: #333; }
        .stat .unit { font-size: 0.6em; }
        /* --- AJOUT : Style pour le graphique objectif --- */
        .goal-chart-container { position: relative; height: 180px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Mes Activités Strava</h1>
        <div id="status">Chargement des données...</div>
        <div id="latest-activity-summary"></div>
        <div id="map-container"></div>
        <div id="chart-container"></div>
        <div id="activities-container"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_URL = "https://projet-strava-api.onrender.com/api/strava";
            const statusDiv = document.getElementById('status');
            const stravaCode = new URLSearchParams(window.location.search).get('code');

            if (!stravaCode) { /* ... (gestion erreur identique) ... */ return; }

            fetch(`${API_URL}?code=${stravaCode}`)
                .then(response => response.json().then(data => ({ ok: response.ok, data })))
                .then(({ ok, data }) => {
                    if (!ok) throw new Error(data.error || 'Erreur inconnue');
                    statusDiv.style.display = 'none';
                    
                    displayLatestSummary(data.activities, data.weekly_summary); // On passe les nouvelles données
                    displayActivitiesList(data.activities);
                    if (data.latest_activity_map) renderMap(data.latest_activity_map);
                    if (data.elevation_data) renderChart(data.elevation_data);
                })
                .catch(error => { /* ... (gestion erreur identique) ... */ });
        });

        // --- MODIFICATION : La fonction reçoit maintenant les données de l'objectif ---
        function displayLatestSummary(activities, weeklySummary) {
            const summaryContainer = document.getElementById('latest-activity-summary');
            if (!activities || activities.length === 0) return;
            const latest = activities[0];
            const distanceKm = (latest.distance / 1000).toFixed(2);

            // On ajoute le canvas pour le nouveau graphique
            summaryContainer.innerHTML = `
                <h2>Dernière activité : ${latest.name}</h2>
                <div class="stats-grid">
                    <div class="stat">
                        <h3>Distance</h3>
                        <p>${distanceKm} <span class="unit">km</span></p>
                    </div>
                    <div class="stat">
                        <h3>Durée</h3>
                        <p>${latest.moving_time}</p>
                    </div>
                    <div class="stat">
                         <h3>Objectif Semaine</h3>
                         <div class="goal-chart-container">
                            <canvas id="weeklyGoalChart"></canvas>
                         </div>
                    </div>
                </div>
            `;
            // Une fois le HTML inséré, on peut dessiner le graphique
            if (weeklySummary) {
                renderGoalChart(weeklySummary);
            }
        }

        // --- AJOUT : Nouvelle fonction pour le graphique objectif ---
        function renderGoalChart(summary) {
            const ctx = document.getElementById('weeklyGoalChart').getContext('2d');
            const current = summary.current;
            const goal = summary.goal;
            const remaining = Math.max(0, goal - current); // Pour ne pas avoir de valeur négative
            const percentage = goal > 0 ? ((current / goal) * 100).toFixed(0) : 0;

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Réalisé', 'Restant'],
                    datasets: [{
                        data: [current, remaining],
                        backgroundColor: ['#fc4c02', '#e5e7eb'],
                        borderColor: ['#ffffff'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%', // Pour l'effet "donut"
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false },
                        title: {
                            display: true,
                            text: `${percentage}%`, // Affiche le pourcentage au centre
                            position: 'bottom',
                            font: { size: 24, weight: 'bold' },
                            color: '#333',
                            padding: { top: -40 } // Ajustement vertical
                        }
                    }
                }
            });
        }
        
        // --- Les autres fonctions (displayActivitiesList, renderMap, etc.) restent inchangées ---
        function displayActivitiesList(a) {/* ... */}
        function renderMap(p) { /* ... */ }
        function renderChart(d) { /* ... */ }
        function decodePolyline(e) { /* ... */ }
        // (Le code complet des autres fonctions est omis ici pour la clarté, mais doit être conservé)
    </script>
</body>
</html>