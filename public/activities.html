<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Mes Activités Strava</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --strava-orange: #fc4c02; --gray-100: #f3f4f6; --gray-200: #e5e7eb;
            --gray-500: #6b7280; --gray-800: #1f2937; --white: #ffffff;
        }
        body { font-family: 'Inter', sans-serif; margin: 0; padding: 24px; background-color: var(--gray-100); color: var(--gray-800); }
        .container { max-width: 1024px; margin: auto; }
        .card { background-color: var(--white); border-radius: 12px; padding: 24px; margin-bottom: 24px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .card-header { border-bottom: 1px solid var(--gray-200); padding-bottom: 16px; margin-bottom: 16px; }
        .card-header h1 { font-size: 1.875rem; font-weight: 700; margin: 0; }
        .card-header p { font-size: 1rem; color: var(--gray-500); margin: 4px 0 0; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat { background-color: var(--gray-100); padding: 16px; border-radius: 8px; text-align: center; }
        .stat h3 { margin: 0 0 8px 0; font-size: 0.875rem; font-weight: 500; color: var(--gray-500); display: flex; align-items: center; justify-content: center; gap: 8px; }
        .stat p { margin: 0; font-size: 1.5rem; font-weight: 700; }
        #map { height: 400px; width: 100%; border-radius: 8px; margin-top: 20px; background-color: var(--gray-200); }
        .chart-container { position: relative; height: 250px; width: 100%; margin-top: 24px; }
        .history-card h2 { font-size: 1.5rem; font-weight: 700; margin-bottom: 16px; }
        .activity-table { width: 100%; border-collapse: collapse; }
        .activity-table th, .activity-table td { padding: 16px; text-align: left; border-bottom: 1px solid var(--gray-200); }
        .activity-table th { background-color: #f9fafb; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--gray-500); }
        .activity-table tr:last-child td { border-bottom: none; }
        .activity-table td { font-weight: 500; }
        .activity-table tr:hover { background-color: #fafafa; }
        .strava-orange { color: var(--strava-orange); }
    </style>
</head>
<body>
    <div class="container" id="main-content" style="display: none;">
        </div>
    <div id="status-container" class="container" style="text-align: center; padding: 50px;">
        <h1>Chargement de vos données Strava...</h1>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_URL = "https://projet-strava-api.onrender.com/api/strava"; // Assurez-vous que l'URL est correcte
            const statusContainer = document.getElementById('status-container');
            const mainContent = document.getElementById('main-content');

            const urlParams = new URLSearchParams(window.location.search);
            const stravaCode = urlParams.get('code');

            if (!stravaCode) {
                statusContainer.innerHTML = "<h1>Erreur : Code d'autorisation manquant.</h1>";
                return;
            }

            fetch(`${API_URL}?code=${stravaCode}`)
                .then(response => {
                    if (!response.ok) throw new Error(`Erreur du serveur (status ${response.status})`);
                    return response.json();
                })
                .then(data => {
                    if (data.error) throw new Error(data.error);
                    statusContainer.style.display = 'none';
                    mainContent.style.display = 'block';
                    renderData(data);
                })
                .catch(error => {
                    console.error("Erreur lors de la récupération des données :", error);
                    statusContainer.innerHTML = `<h1>Une erreur est survenue</h1><p>${error.message}</p>`;
                });
        });

        function renderData(data) {
            if (!data.activities || data.activities.length === 0) {
                mainContent.innerHTML = "<h1>Aucune activité trouvée.</h1>";
                return;
            }
            
            const latest = data.activities[0];
            const mainContentHTML = `
                <div class="card">
                    <div class="card-header">
                        <p>${formatDate(latest.start_date_local)}</p>
                        <h1>${latest.name}</h1>
                    </div>
                    <div class="stats-grid" id="stats-grid-container"></div>
                    ${latest.map && latest.map.summary_polyline ? '<div id="map"></div>' : ''}
                    ${data.elevation_data ? '<div class="chart-container"><canvas id="elevationChart"></canvas></div>' : ''}
                </div>
                <div class="card history-card">
                    <h2>Historique</h2>
                    <table class="activity-table">
                        <thead>
                            <tr>
                                <th>Nom</th><th>Type</th><th>Date</th><th>Distance</th><th>Dénivelé</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body"></tbody>
                    </table>
                </div>
            `;
            mainContent.innerHTML = mainContentHTML;

            const statsGrid = document.getElementById('stats-grid-container');
            statsGrid.innerHTML = `
                ${createStat('ruler', 'Distance', `${(latest.distance / 1000).toFixed(2)}`, 'km')}
                ${createStat('timer', 'Temps', latest.moving_time)}
                ${createStat('trending-up', 'Dénivelé', `${latest.total_elevation_gain.toFixed(0)}`, 'm')}
                ${latest.average_speed ? createStat('gauge-circle', 'Vitesse Moy.', `${(latest.average_speed * 3.6).toFixed(1)}`, 'km/h') : ''}
                ${latest.max_speed ? createStat('chevrons-up-right', 'Vitesse Max.', `${(latest.max_speed * 3.6).toFixed(1)}`, 'km/h') : ''}
                ${latest.has_heartrate ? createStat('heart-pulse', 'FC Moyenne', `${latest.average_heartrate.toFixed(0)}`, 'bpm') : ''}
                ${latest.has_heartrate && latest.max_heartrate ? createStat('activity', 'FC Max.', `${latest.max_heartrate.toFixed(0)}`, 'bpm') : ''}
                ${latest.average_watts ? createStat('zap', 'Puissance Moy.', `${latest.average_watts.toFixed(0)}`, 'W') : ''}
                ${latest.average_cadence ? createStat('repeat', 'Cadence Moy.', `${latest.average_cadence.toFixed(0)}`, 'rpm') : ''}
                ${latest.calories ? createStat('flame', 'Calories', `${latest.calories.toFixed(0)}`, 'kcal') : ''}
            `;

            const historyTableBody = document.getElementById('history-table-body');
            data.activities.forEach(activity => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="strava-orange">${activity.name}</td>
                    <td>${activity.type}</td>
                    <td>${new Date(activity.start_date_local).toLocaleDateString('fr-FR')}</td>
                    <td>${(activity.distance / 1000).toFixed(2)} km</td>
                    <td>${activity.total_elevation_gain.toFixed(0)} m</td>
                `;
                historyTableBody.appendChild(row);
            });

            if (latest.map && latest.map.summary_polyline) renderMap(latest.map.summary_polyline);
            if (data.elevation_data) renderChart(data.elevation_data);

            lucide.createIcons();
        }

        function createStat(icon, label, value, unit = '') {
            return `
                <div class="stat">
                    <h3><i data-lucide="${icon}"></i>${label}</h3>
                    <p>${value} <span style="font-size: 0.7em; color: var(--gray-500);">${unit}</span></p>
                </div>`;
        }
        
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }
        
        // ===================================================================
        // == FONCTIONS HELPER (CARTES, GRAPHIQUES, ETC.) - CODE AJOUTÉ ICI ==
        // ===================================================================
        
        function decodePolyline(encoded) {
            let len = encoded.length;
            let index = 0;
            let lat = 0;
            let lng = 0;
            let array = [];
            while (index < len) {
                let b;
                let shift = 0;
                let result = 0;
                do {
                    b = encoded.charCodeAt(index++) - 63;
                    result |= (b & 0x1f) << shift;
                    shift += 5;
                } while (b >= 0x20);
                let dlat = ((result & 1) ? ~(result >> 1) : (result >> 1));
                lat += dlat;
                shift = 0;
                result = 0;
                do {
                    b = encoded.charCodeAt(index++) - 63;
                    result |= (b & 0x1f) << shift;
                    shift += 5;
                } while (b >= 0x20);
                let dlng = ((result & 1) ? ~(result >> 1) : (result >> 1));
                lng += dlng;
                array.push([lat * 1e-5, lng * 1e-5]);
            }
            return array;
        }

        function renderMap(encodedPolyline) {
            try {
                const decodedPath = decodePolyline(encodedPolyline);
                if (decodedPath && decodedPath.length > 0) {
                    const map = L.map('map');
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(map);
                    const polyline = L.polyline(decodedPath, {
                        color: '#fc4c02',
                        weight: 4
                    }).addTo(map);
                    map.fitBounds(polyline.getBounds());
                }
            } catch (e) {
                console.error("Erreur lors de la création de la carte:", e);
                document.getElementById('map').innerHTML = "Impossible d'afficher la carte.";
            }
        }

        function renderChart(elevationData) {
            if (!elevationData || !elevationData.distance || !elevationData.altitude) return;
            
            const ctx = document.getElementById('elevationChart').getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, 250);
            gradient.addColorStop(0, 'rgba(252, 76, 2, 0.4)');
            gradient.addColorStop(1, 'rgba(252, 76, 2, 0)');
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: elevationData.distance.map(d => (d / 1000).toFixed(1)),
                    datasets: [{
                        label: 'Altitude (m)',
                        data: elevationData.altitude,
                        borderColor: '#fc4c02',
                        backgroundColor: gradient,
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: 'Distance (km)' } },
                        y: { title: { display: true, text: 'Altitude (m)' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }
    </script>
</body>
</html>