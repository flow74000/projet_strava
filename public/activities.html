<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mes Activités Strava</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f4f4; color: #333; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 800px; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #fc4c02; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        #status { font-size: 1.2em; font-weight: bold; text-align: center; padding: 40px; }
        .activity { border-bottom: 1px solid #eee; padding: 15px 5px; margin-bottom: 10px; }
        .activity h3 { margin-top: 0; }
        .activity p { margin: 5px 0; }
        #map { height: 400px; width: 100%; border-radius: 8px; margin-top: 20px; background-color: #eee; }
        .chart-container { position: relative; height: 250px; width: 100%; margin-top: 24px; }
        
        #summary { margin-bottom: 30px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .stat { background-color: #f9f9f9; padding: 20px; border-radius: 8px; text-align: center; border: 1px solid #eee; }
        .stat h3 { margin: 0 0 8px 0; font-size: 0.9em; color: #555; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat p { margin: 0; font-size: 1.8em; font-weight: 600; color: #333; }
        .stat .unit { font-size: 0.6em; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Mes Activités Strava</h1>
        <div id="status">Chargement des données...</div>
        <div id="latest-activity-summary"></div>
        <div id="map-container"></div>
        <div id="chart-container"></div>
        <div id="activities-container"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ... (le début du script fetch reste identique) ...
            
            fetch(`${API_URL}?code=${stravaCode}`)
                .then(response => response.json().then(data => ({ ok: response.ok, data })))
                .then(({ ok, data }) => {
                    if (!ok) throw new Error(data.error || 'Erreur inconnue');
                    statusDiv.style.display = 'none';
                    
                    displayLatestSummary(data.activities);
                    displayActivitiesList(data.activities);
                    if (data.latest_activity_map) renderMap(data.latest_activity_map);
                    if (data.elevation_data) renderChart(data.elevation_data);
                })
                .catch(error => { /* ... (gestion d'erreur identique) ... */ });
        });

        // --- MODIFICATION ICI : On affiche toutes les stats ---
        function displayLatestSummary(activities) {
            const summaryContainer = document.getElementById('latest-activity-summary');
            if (!activities || activities.length === 0) return;

            const latest = activities[0];

            // On crée les blocs de statistiques un par un
            const distanceStat = createStat('Distance', `${(latest.distance / 1000).toFixed(2)}`, 'km');
            const timeStat = createStat('Durée', latest.moving_time);
            const elevationStat = createStat('Dénivelé', `${latest.total_elevation_gain.toFixed(0)}`, 'm');
            
            const speedStat = createStat('Vitesse', 
                `${(latest.average_speed * 3.6).toFixed(1)} <span class="unit">moy</span> / ${(latest.max_speed * 3.6).toFixed(1)} <span class="unit">max</span>`, 
                'km/h'
            );
            
            const hrStat = latest.has_heartrate 
                ? createStat('Fréq. Cardiaque', `${latest.average_heartrate.toFixed(0)} <span class="unit">moy</span> / ${latest.max_heartrate.toFixed(0)} <span class="unit">max</span>`, 'bpm') 
                : '';
                
            const powerStat = latest.average_watts 
                ? createStat('Puissance', `${latest.average_watts.toFixed(0)} <span class="unit">moy</span> / ${latest.max_watts.toFixed(0)} <span class="unit">max</span>`, 'W') 
                : '';

            summaryContainer.innerHTML = `
                <h2>Dernière activité : ${latest.name}</h2>
                <div class="stats-grid">
                    ${distanceStat}
                    ${timeStat}
                    ${elevationStat}
                    ${speedStat}
                    ${hrStat}
                    ${powerStat}
                </div>
            `;
        }
        
        // Nouvelle fonction helper pour créer un bloc de stat
        function createStat(label, value, unit = '') {
            return `
                <div class="stat">
                    <h3>${label}</h3>
                    <p>${value} <span class="unit">${unit}</span></p>
                </div>`;
        }

        function displayActivitiesList(activities) {
            // ... (cette fonction reste identique à la version précédente)
        }
        
        // --- Les autres fonctions (map, chart, etc.) restent les mêmes ---
        const API_URL = "https://projet-strava-api.onrender.com/api/strava";
        const statusDiv = document.getElementById('status');
        const stravaCode = new URLSearchParams(window.location.search).get('code');
        function renderMap(p) { /* ... (code inchangé) ... */ }
        function renderChart(d) { /* ... (code inchangé) ... */ }
        function decodePolyline(e) { /* ... (code inchangé) ... */ }
        
        function displayActivitiesList(activities) { const container=document.getElementById('activities-container'); if (!activities || activities.length===0) { container.innerHTML="<h2>Aucune activité trouvée.</h2>"; return; } container.innerHTML='<h2>Historique des activités</h2>'; activities.forEach(activity => { const distanceKm=(activity.distance / 1000).toFixed(2); const elevation=activity.total_elevation_gain.toFixed(0); const date=new Date(activity.start_date_local).toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }); const activityElement=document.createElement('div'); activityElement.className='activity'; activityElement.innerHTML=`<h3>${activity.name}</h3><p><strong>Date :</strong> ${date}</p><p><strong>Distance :</strong> ${distanceKm} km</p><p><strong>Dénivelé :</strong> ${elevation} m</p>`; container.appendChild(activityElement); }); }
        function renderMap(encodedPolyline){const mapContainer=document.getElementById('map-container');mapContainer.innerHTML='<h2>Tracé de la dernière activité</h2><div id="map"></div>';try{const decodedPath=decodePolyline(encodedPolyline);if(decodedPath&&decodedPath.length>0){const map=L.map('map');L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap'}).addTo(map);const polyline=L.polyline(decodedPath,{color:'#fc4c02',weight:4}).addTo(map);map.fitBounds(polyline.getBounds().pad(0.1));}}catch(e){console.error("Erreur carte:",e);}}
        function renderChart(elevationData){const chartContainer=document.getElementById('chart-container');chartContainer.innerHTML='<h2>Profil d\'altitude</h2><div class="chart-container"><canvas id="elevationChart"></canvas></div>';const ctx=document.getElementById('elevationChart').getContext('2d');const gradient=ctx.createLinearGradient(0,0,0,250);gradient.addColorStop(0,'rgba(252,76,2,0.4)');gradient.addColorStop(1,'rgba(252,76,2,0)');new Chart(ctx,{type:'line',data:{labels:elevationData.distance.map(d=>(d/1000).toFixed(1)),datasets:[{label:'Altitude (m)',data:elevationData.altitude,borderColor:'#fc4c02',backgroundColor:gradient,borderWidth:2,pointRadius:0,fill:true,tension:0.3}]},options:{responsive:true,maintainAspectRatio:false,scales:{x:{title:{display:true,text:'Distance (km)'}},y:{title:{display:true,text:'Altitude (m)'}}},plugins:{legend:{display:false}}}});}
        function decodePolyline(encoded){let len=encoded.length;let index=0;let lat=0;let lng=0;let array=[];while(index<len){let b;let shift=0;let result=0;do{b=encoded.charCodeAt(index++)-63;result|=(b&0x1f)<<shift;shift+=5;}while(b>=0x20);let dlat=((result&1)?~(result>>1):(result>>1));lat+=dlat;shift=0;result=0;do{b=encoded.charCodeAt(index++)-63;result|=(b&0x1f)<<shift;shift+=5;}while(b>=0x20);let dlng=((result&1)?~(result>>1):(result>>1));lng+=dlng;array.push([lat*1e-5,lng*1e-5]);}return array;}
    </script>
</body>
</html>