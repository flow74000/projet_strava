<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Mon Tableau de Bord Strava</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* ... (tous les styles CSS précédents restent les mêmes) ... */
    </style>
</head>
<body>
    <div class="main-container">
        <div id="content-wrapper" style="display: none;">
            <div class="card">
                </div>

            <div class="card" id="form-chart-card" style="display: none;">
                <h2>Évolution de la Forme (90 jours)</h2>
                <div class="chart-container">
                    <canvas id="formChart"></canvas>
                </div>
            </div>

            <div class="card" id="chart-card" style="display: none;">
                </div>
            <div class="card">
                </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/3.0.1/chartjs-plugin-annotation.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ... (logique fetch inchangée) ...
            fetch(/*...*/)
                .then(/*...*/)
                .then(({ ok, data }) => {
                    // ... (logique inchangée)
                    renderPage(data);
                });
        });

        function renderPage(data) {
            renderGoals(data.goals);
            renderFitnessSummary(data.fitness_summary);
            renderLatestActivity(data.activities, data.latest_activity_map, data.elevation_data);
            renderHistory(data.activities);
            
            // On appelle la nouvelle fonction pour le graphique de forme
            if (data.form_chart_data) {
                document.getElementById('form-chart-card').style.display = 'block';
                renderFormChart(data.form_chart_data);
            }

            lucide.createIcons();
        }

        // NOUVELLE FONCTION POUR LE GRAPHIQUE DE FORME
        function renderFormChart(data) {
            const ctx = document.getElementById('formChart').getContext('2d');
            
            const labels = data.map(d => new Date(d.id));
            const tsbData = data.map(d => (d.ctl != null && d.atl != null) ? d.ctl - d.atl : null);

            const getFormColor = (value) => {
                if (value === null || isNaN(value)) return 'rgba(107, 114, 128, 0.5)'; // Gris
                if (value > 5) return '#3b82f6';     // Frais (Bleu)
                if (value > -10) return '#22c55e';   // Optimal (Vert)
                if (value > -25) return '#6b7280';   // Zone Grise
                return '#ef4444';                    // Risque Élevé (Rouge)
            };

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Forme (TSB)',
                        data: tsbData,
                        borderWidth: 2.5,
                        tension: 0.4,
                        pointRadius: 0,
                        segment: {
                            borderColor: ctx => getFormColor(ctx.p1.raw)
                        }
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { type: 'time', time: { unit: 'week' } },
                        y: { title: { display: true, text: 'Forme (TSB)' } }
                    },
                    plugins: {
                        legend: { display: false },
                        annotation: {
                            annotations: {
                                highRisk: { type: 'box', yMin: -Infinity, yMax: -25, backgroundColor: 'rgba(239, 68, 68, 0.05)', borderColor: 'transparent' },
                                greyZone: { type: 'box', yMin: -25, yMax: -10, backgroundColor: 'rgba(107, 114, 128, 0.05)', borderColor: 'transparent' },
                                optimal: { type: 'box', yMin: -10, yMax: 5, backgroundColor: 'rgba(34, 197, 94, 0.05)', borderColor: 'transparent' },
                                fresh: { type: 'box', yMin: 5, yMax: Infinity, backgroundColor: 'rgba(59, 130, 246, 0.05)', borderColor: 'transparent' }
                            }
                        }
                    }
                }
            });
        }
        
        // ... (toutes les autres fonctions JavaScript restent identiques)
    </script>
</body>
</html>