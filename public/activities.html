<!DOCTYPE html>
<html lang="fr">
<head>
    <style>
        /* ... (styles CSS existants) ... */
        .activity-table tbody tr { cursor: pointer; }
        .activity-table tbody tr:hover { background-color: #f9fafb; }
        .activity-table tbody tr.selected { background-color: #fff7ed; }
    </style>
</head>
<body>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/3.0.1/chartjs-plugin-annotation.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        // --- MODIFICATION : On déclare une variable pour stocker les données ---
        let allActivitiesData = [];

        document.addEventListener('DOMContentLoaded', () => {
            // ... (logique fetch inchangée) ...
            fetch(/*...*/)
                .then(/*...*/)
                .then(({ ok, data }) => {
                    if (!ok) throw new Error(data.error || 'Erreur inconnue');
                    statusContainer.style.display = 'none';
                    contentWrapper.style.display = 'block';
                    
                    // On stocke les données pour un usage ultérieur
                    allActivitiesData = data.activities;
                    
                    renderPage(data);
                })
        });

        function renderPage(data, selectedIndex = 0) { // On peut choisir quelle activité afficher
            renderGoals(data.goals);
            renderFitnessSummary(data.fitness_summary);
            
            // On affiche le détail de l'activité sélectionnée (par défaut la première)
            renderLatestActivity(data.activities, selectedIndex);
            
            if (data.form_chart_data) {
                 document.getElementById('form-chart-card').style.display = 'block';
                 renderFormChart(data.form_chart_data);
            }
            renderHistory(data.activities, selectedIndex);
            lucide.createIcons();
        }

        function renderLatestActivity(activities, index) {
            const summaryTitle = document.getElementById('latest-activity-summary');
            const detailsContainer = document.getElementById('summary-details-container');
            if (!activities || activities.length === 0) return;

            const latest = activities[index]; // On utilise l'index
            summaryTitle.innerHTML = `<h2>Détail de l'activité</h2>`;
            detailsContainer.innerHTML = `<p class="date">${formatDate(latest.start_date_local)}</p><h3>${latest.name}</h3>${createStatDetail('ruler','Distance',`${(latest.distance/1000).toFixed(2)}`,'km')}${createStatDetail('timer','Durée',formatMovingTime(latest.moving_time))}${createStatDetail('trending-up','Dénivelé',`${latest.total_elevation_gain.toFixed(0)}`,'m')}`;
            
            // On affiche la carte et le graphique de l'activité sélectionnée
            renderMap(latest.map_polyline);
            if (latest.elevation_data) {
                document.getElementById('elevation-chart-card').style.display = 'block';
                renderChart(latest.elevation_data, 'elevationChart');
            } else {
                document.getElementById('elevation-chart-card').style.display = 'none';
            }
        }

        function renderHistory(activities, selectedIndex) {
            const historyTableBody = document.getElementById('history-table-body');
            if (!activities || !activities.length) return;
            
            historyTableBody.innerHTML = '';
            activities.forEach((activity, index) => {
                const row = document.createElement('tr');
                // On ajoute une classe 'selected' si c'est la ligne de l'activité affichée
                if (index === selectedIndex) {
                    row.classList.add('selected');
                }
                // On stocke l'index dans un attribut pour le retrouver au clic
                row.dataset.index = index;
                row.innerHTML = `<td class="strava-orange">${activity.name}</td><td>${(activity.distance / 1000).toFixed(2)} km</td><td>${new Date(activity.start_date_local).toLocaleDateString('fr-FR')}</td>`;
                historyTableBody.appendChild(row);
            });
            
            // --- AJOUT : On attache l'écouteur d'événement pour les clics ---
            historyTableBody.addEventListener('click', handleHistoryClick);
        }

        function handleHistoryClick(event) {
            const clickedRow = event.target.closest('tr');
            if (!clickedRow) return;

            const index = parseInt(clickedRow.dataset.index, 10);
            
            // On redessine les sections qui doivent changer
            renderLatestActivity(allActivitiesData, index);
            
            // On met à jour la sélection visuelle dans le tableau
            const tableBody = clickedRow.parentNode;
            tableBody.querySelector('tr.selected')?.classList.remove('selected');
            clickedRow.classList.add('selected');

            lucide.createIcons(); // On réactive les icônes
        }

        // ... (toutes les autres fonctions JavaScript restent identiques)
    </script>
</body>
</html>