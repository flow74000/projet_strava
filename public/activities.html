<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mes Activités Strava</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --strava-orange: #fc4c02; --gray-100: #f3f4f6; --gray-200: #e5e7eb;
            --gray-500: #6b7280; --gray-800: #1f2937; --white: #ffffff;
        }
        body { font-family: 'Inter', sans-serif; margin: 0; padding: 24px; background-color: var(--gray-100); color: var(--gray-800); }
        .container { max-width: 1024px; margin: auto; }
        .card { background-color: var(--white); border-radius: 12px; padding: 24px; margin-bottom: 24px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .card-header { border-bottom: 1px solid var(--gray-200); padding-bottom: 16px; margin-bottom: 16px; }
        .card-header h1 { font-size: 1.875rem; font-weight: 700; margin: 0; }
        .card-header p { font-size: 1rem; color: var(--gray-500); margin: 4px 0 0; }
        
        /* NOUVELLE GRILLE POUR LA VUE DÉTAILLÉE */
        .latest-activity-grid {
            display: grid;
            grid-template-columns: 2fr 1fr; /* 2/3 pour la carte, 1/3 pour les stats */
            gap: 24px;
            align-items: flex-start;
        }
        #map { height: 450px; width: 100%; border-radius: 8px; background-color: var(--gray-200); }
        
        /* NOUVEAU PANNEAU DE STATS */
        .stats-panel {
            background-color: var(--gray-100);
            padding: 20px;
            border-radius: 8px;
        }
        .stats-panel h3 {
            margin-top: 0;
            font-size: 1.2rem;
            border-bottom: 1px solid var(--gray-200);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--gray-200);
        }
        .stat-item:last-child { border-bottom: none; }
        .stat-label { display: flex; align-items: center; gap: 8px; font-weight: 500; color: var(--gray-500); font-size: 0.9em; }
        .stat-value { font-weight: 600; font-size: 1rem; }
        .stat-value .unit { font-size: 0.8em; color: var(--gray-500); }
        
        .chart-container { position: relative; height: 250px; width: 100%; margin-top: 24px; }
        .history-card h2 { font-size: 1.5rem; font-weight: 700; margin-bottom: 16px; }
        .activity-table { width: 100%; border-collapse: collapse; }
        .activity-table th, .activity-table td { padding: 16px; text-align: left; border-bottom: 1px solid var(--gray-200); }
        .activity-table th { background-color: #f9fafb; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--gray-500); }
        .activity-table td { font-weight: 500; }
        .strava-orange { color: var(--strava-orange); }
    </style>
</head>
<body>
    <div class="container" id="main-content" style="display: none;">
        </div>
    <div id="status-container" class="container" style="text-align: center; padding: 50px;">
        <h1>Chargement de vos données Strava...</h1>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_URL = "https://projet-strava-api.onrender.com/api/strava";
            const statusContainer = document.getElementById('status-container');
            const mainContent = document.getElementById('main-content');

            const urlParams = new URLSearchParams(window.location.search);
            const stravaCode = urlParams.get('code');

            if (!stravaCode) {
                statusContainer.innerHTML = "<h1>Erreur : Code d'autorisation manquant.</h1>";
                return;
            }

            fetch(`${API_URL}?code=${stravaCode}`)
                .then(response => {
                    if (!response.ok) throw new Error(`Erreur du serveur (status ${response.status})`);
                    return response.json();
                })
                .then(data => {
                    if (data.error) throw new Error(data.error);
                    statusContainer.style.display = 'none';
                    mainContent.style.display = 'block';
                    renderData(data);
                })
                .catch(error => {
                    console.error("Erreur:", error);
                    statusContainer.innerHTML = `<h1>Une erreur est survenue</h1><p>${error.message}</p>`;
                });
        });

        function renderData(data) {
            if (!data.activities || data.activities.length === 0) {
                mainContent.innerHTML = "<h1>Aucune activité trouvée.</h1>";
                return;
            }
            
            const latest = data.activities[0];
            
            // On construit la nouvelle structure HTML
            const mainContentHTML = `
                <div class="card">
                    <div class="card-header">
                        <p>${formatDate(latest.start_date_local)}</p>
                        <h1>${latest.name}</h1>
                    </div>
                    <div class="latest-activity-grid">
                        <div id="map"></div>
                        <div class="stats-panel" id="stats-panel-content">
                            </div>
                    </div>
                    ${data.elevation_data ? '<div class="chart-container"><canvas id="elevationChart"></canvas></div>' : ''}
                </div>
                <div class="card history-card">
                    <h2>Historique des activités</h2>
                    <table class="activity-table">
                        <tbody id="history-table-body"></tbody>
                    </table>
                </div>
            `;
            mainContent.innerHTML = mainContentHTML;

            // Remplissage du nouveau panneau de statistiques
            const statsPanel = document.getElementById('stats-panel-content');
            statsPanel.innerHTML = `
                <h3>Statistiques Clés</h3>
                ${createStatDetail('ruler', 'Distance', (latest.distance / 1000).toFixed(2), 'km')}
                ${createStatDetail('timer', 'Durée', latest.moving_time)}
                ${createStatDetail('trending-up', 'Dénivelé', latest.total_elevation_gain.toFixed(0), 'm')}
                ${createStatDetail('gauge-circle', 'Vitesse', `${(latest.average_speed * 3.6).toFixed(1)} <span class='unit'>moy.</span> / ${(latest.max_speed * 3.6).toFixed(1)} <span class='unit'>max</span>`, 'km/h')}
                ${latest.average_watts ? createStatDetail('zap', 'Puissance', `${latest.average_watts.toFixed(0)} <span class='unit'>moy.</span> / ${latest.max_watts.toFixed(0)} <span class='unit'>max</span>`, 'W') : ''}
                ${latest.has_heartrate ? createStatDetail('heart-pulse', 'Fréq. Cardiaque', `${latest.average_heartrate.toFixed(0)} <span class='unit'>moy.</span> / ${latest.max_heartrate.toFixed(0)} <span class='unit'>max</span>`, 'bpm') : ''}
            `;

            // Remplissage de la table de l'historique
            const historyTableBody = document.getElementById('history-table-body');
            data.activities.forEach(activity => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="strava-orange">${activity.name}</td>
                    <td>${(activity.distance / 1000).toFixed(2)} km</td>
                    <td>${activity.total_elevation_gain.toFixed(0)} m</td>
                `;
                historyTableBody.appendChild(row);
            });
            
            // Rendu de la carte et du graphique
            if (latest.map && latest.map.summary_polyline) renderMap(latest.map.summary_polyline);
            if (data.elevation_data) renderChart(data.elevation_data);

            lucide.createIcons();
        }

        function createStatDetail(icon, label, value, unit) {
            return `
                <div class="stat-item">
                    <div class="stat-label"><i data-lucide="${icon}"></i>${label}</div>
                    <div class="stat-value">${value} <span class="unit">${unit}</span></div>
                </div>`;
        }
        
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }
        
        // --- Fonctions pour la carte et le graphique (inchangées) ---
        function decodePolyline(encoded) { /* ... code de décodage ... */ }
        function renderMap(encodedPolyline) { /* ... code de la carte ... */ }
        function renderChart(elevationData) { /* ... code du graphique ... */ }

        // Collez ici le code complet des fonctions decodePolyline, renderMap, et renderChart
        function decodePolyline(encoded) {let len=encoded.length;let index=0;let lat=0;let lng=0;let array=[];while(index<len){let b;let shift=0;let result=0;do{b=encoded.charCodeAt(index++)-63;result|=(b&0x1f)<<shift;shift+=5;}while(b>=0x20);let dlat=((result&1)?~(result>>1):(result>>1));lat+=dlat;shift=0;result=0;do{b=encoded.charCodeAt(index++)-63;result|=(b&0x1f)<<shift;shift+=5;}while(b>=0x20);let dlng=((result&1)?~(result>>1):(result>>1));lng+=dlng;array.push([lat*1e-5,lng*1e-5]);}return array;}
        function renderMap(encodedPolyline) {try {const decodedPath=decodePolyline(encodedPolyline);if(decodedPath&&decodedPath.length>0){const map=L.map('map');L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(map);const polyline=L.polyline(decodedPath,{color:'#fc4c02',weight:4}).addTo(map);map.fitBounds(polyline.getBounds().pad(0.1));}} catch(e) {console.error("Erreur carte:",e);document.getElementById('map').innerHTML="Impossible d'afficher la carte.";}}
        function renderChart(elevationData) {if(!elevationData||!elevationData.distance||!elevationData.altitude)return;const ctx=document.getElementById('elevationChart').getContext('2d');const gradient=ctx.createLinearGradient(0,0,0,250);gradient.addColorStop(0,'rgba(252, 76, 2, 0.4)');gradient.addColorStop(1,'rgba(252, 76, 2, 0)');new Chart(ctx,{type:'line',data:{labels:elevationData.distance.map(d=>(d/1000).toFixed(1)),datasets:[{label:'Altitude (m)',data:elevationData.altitude,borderColor:'#fc4c02',backgroundColor:gradient,borderWidth:2,pointRadius:0,fill:true,tension:0.3}]},options:{responsive:true,maintainAspectRatio:false,scales:{x:{title:{display:true,text:'Distance (km)'}},y:{title:{display:true,text:'Altitude (m)'}}},plugins:{legend:{display:false}}}});}
    </script>
</body>
</html>