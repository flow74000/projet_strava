<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Mon Tableau de Bord Strava</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&display=swap" rel="stylesheet">
    <style>
        :root { --strava-orange: #fc5200; --gray-100: #f3f4f6; --gray-200: #e5e7eb; --gray-500: #6b7280; --gray-800: #1f2937; --white: #ffffff; --form-green: #22c55e; --form-blue: #3b82f6; --form-red: #ef4444; }
        body { font-family: 'Lato', sans-serif; margin: 0; padding: 24px; background-color: var(--gray-100); }
        .main-container { max-width: 1200px; margin: auto; }
        .card { background-color: var(--white); border-radius: 12px; padding: 24px; margin-bottom: 24px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        h1, h2 { color: var(--gray-800); margin-top: 0; }
        h1 { font-size: 2.25rem; font-weight: 800; }
        h2 { font-size: 1.5rem; font-weight: 700; padding-bottom: 16px; border-bottom: 1px solid var(--gray-200); }
        .main-nav { display: flex; justify-content: center; gap: 1rem; border-bottom: 1px solid var(--gray-200); margin-bottom: 24px; }
        .main-nav a { font-weight: 600; text-align: center; color: var(--gray-500); border-bottom: 3px solid transparent; padding: 1rem; text-decoration: none; transition: all 0.2s ease-in-out; }
        .main-nav a:hover { color: var(--gray-800); border-bottom-color: var(--gray-300); }
        .main-nav a.active { color: var(--strava-orange); border-bottom-color: var(--strava-orange); }
        .login-button { background-color: var(--strava-orange); color: white; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: bold; display: inline-block; margin-top: 20px; }
        .dashboard-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; flex-wrap: wrap; gap: 20px; }
        .goals-container { display: flex; gap: 24px; }
        .goal-stat { display: flex; align-items: center; gap: 16px; }
        .goal-chart-container { position: relative; width: 70px; height: 70px; }
        .goal-percentage { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.2rem; font-weight: 600; }
        .goal-details h3 { margin: 0; font-size: 1rem; color: var(--gray-500); font-weight: 500; text-transform: uppercase; }
        .goal-details p { margin: 4px 0 0; font-size: 1.2rem; font-weight: 600; }
        .goal-details .sub { font-size: 0.9rem; color: var(--gray-500); }
        .fitness-section { display: grid; grid-template-columns: 1fr; gap: 24px; }
        @media (min-width: 1024px) { .fitness-section { grid-template-columns: 2fr 3fr; } }
        .fitness-stats-cards { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
        .summary-card { padding: 16px; text-align: center; border-radius: 10px; background-color: var(--white); border: 1px solid var(--gray-200); }
        .summary-card h3 { display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.8rem; font-weight: 600; color: var(--gray-500); text-transform: uppercase; margin-bottom: 8px; }
        .summary-card p { font-size: 2rem; font-weight: 800; color: var(--gray-800); margin: 0; }
        .latest-activity-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 24px; align-items: flex-start; }
        #map { height: 400px; width: 100%; border-radius: 8px; background-color: var(--gray-200); }
        .summary-panel .date { font-size: 1rem; color: var(--gray-500); margin-bottom: 4px; }
        .summary-panel h3 { font-size: 1.875rem; font-weight: 700; margin: 0 0 24px 0; }
        .stat-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--gray-200); }
        .stat-label { display: flex; align-items: center; gap: 10px; font-weight: 500; color: var(--gray-500); }
        .stat-value { font-weight: 600; font-size: 1.1rem; }
        .fitness-chart-container { position: relative; height: 200px; width: 100%; margin-bottom: 16px; }
        .form-chart-container { position: relative; height: 100px; width: 100%; }
        .chart-container { position: relative; height: 350px; width: 100%; }
        .activity-table { width: 100%; border-collapse: collapse; }
        .activity-table tbody tr { cursor: pointer; }
        .activity-table tbody tr:hover { background-color: #f9fafb; }
        .activity-table tbody tr.selected { background-color: #fff7ed; }
        .activity-table td { padding: 16px; text-align: left; border-bottom: 1px solid var(--gray-200); font-weight: 500; }
        .activity-table .strava-orange { color: var(--strava-orange); font-weight: 600; }
    </style>
</head>
<body>
    <div class="main-container">
        <div id="login-container" class="card" style="display: none; text-align: center; padding: 40px;">
            <h1>Bienvenue sur votre Tableau de Bord</h1>
            <p>Veuillez vous connecter avec Strava pour afficher vos données.</p>
            <a href="https://projet-strava-api.onrender.com/api/login" class="login-button">Se connecter avec Strava</a>
        </div>

        <div id="status-container" class="card" style="text-align: center; font-size: 1.2em; font-weight: bold; padding: 40px;">Vérification de l'authentification...</div>
        
        <div id="content-wrapper" style="display: none;">
            <nav class="main-nav">
                <a href="/activities.html" class="active">Accueil</a>
                <a href="/nutrition.html">Nutrition</a>
                <a href="#">Entrainement</a>
                <a href="#">Historique</a>
            </nav>
<div class="dashboard-header">
    <h1>Mon Tableau de Bord</h1>
    <div class="goals-container" id="goals-container"></div>
    <button id="logout-button" style="...">Déconnexion</button>
</div>
            <div class="card"><h2 >Condition Physique</h2><div class="fitness-section"><div id="fitness-summary-cards" class="fitness-stats-cards"></div><div id="charts-column"><div class="fitness-chart-container"><canvas id="fitnessFatigueChart"></canvas></div><div class="form-chart-container"><canvas id="formChart"></canvas></div></div></div></div>
            <div class="card" id="progression-card" style="display: none;"><h2>Progression Annuelle</h2><div class="chart-container"><canvas id="progressionChart"></canvas></div></div>
            <div class="card"><h2 id="latest-activity-title">Dernière Activité</h2><div class="latest-activity-grid"><div id="summary-details-container" class="summary-panel"></div><div id="map-container"></div></div><div id="elevation-chart-card" style="display: none;" class="mt-6"><div class="chart-container" style="height: 200px;"><canvas id="elevationChart"></canvas></div></div></div>
            <div class="card"><h2>Historique</h2><table class="activity-table"><tbody id="history-table-body"></tbody></table></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/3.0.1/chartjs-plugin-annotation.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        let allActivitiesData = [], weeklyGoalChart, yearlyGoalChart, formChart, elevationChart, fitnessFatigueChart, progressionChart;
        
        const API_BASE_URL = "https://projet-strava-api.onrender.com";

        document.addEventListener('DOMContentLoaded', () => {
            const loginContainer = document.getElementById('login-container');
            const statusContainer = document.getElementById('status-container');
            const contentWrapper = document.getElementById('content-wrapper');
            const stravaCode = new URLSearchParams(window.location.search).get('code');

            fetch(`${API_BASE_URL}/api/check_auth`)
                .then(res => res.json())
                .then(authData => {
                    if (authData.authenticated) {
                        console.log("Utilisateur authentifié par session.");
                        fetchData();
                    } 
                    else if (stravaCode) {
                        console.log("Nouvelle authentification via code Strava.");
                        fetchData(stravaCode);
                    } 
                    else {
                        console.log("Utilisateur non authentifié.");
                        statusContainer.style.display = 'none';
                        loginContainer.style.display = 'block';
                    }
                })
                .catch(err => {
                    statusContainer.innerHTML = `<h1>Une erreur de connexion est survenue</h1><p>${err.message}</p>`;
                });
        });

        function fetchData(code = null) {
            const statusContainer = document.getElementById('status-container');
            statusContainer.innerHTML = 'Chargement des données...';
            statusContainer.style.display = 'block';

            let url = `${API_BASE_URL}/api/strava`;
            if (code) {
                url += `?code=${code}`;
            }

            fetch(url)
                .then(response => {
                    if (response.status === 401) {
                        window.location.href = `${API_BASE_URL}/api/login`;
                        return;
                    }
                    if (!response.ok) throw new Error('Erreur serveur lors de la récupération des données.');
                    return response.json();
                })
                .then(data => {
                    if (!data) return;
                    statusContainer.style.display = 'none';
                    document.getElementById('content-wrapper').style.display = 'block';
                    allActivitiesData = data.activities; 
                    renderPage(data);
                    
                    window.history.replaceState({}, document.title, "/activities.html");
                })
                .catch(error => { 
                    console.error("Erreur:", error); 
                    statusContainer.innerHTML = `<h1>Une erreur est survenue</h1><p>${error.message}</p>`; 
                });
        }

        document.getElementById('logout-button')?.addEventListener('click', () => {
            fetch(`${API_BASE_URL}/api/logout`)
                .then(() => {
                    window.location.href = '/activities.html';
                });
        });
        
        function renderPage(data, selectedIndex = 0) {
            renderGoals(data.goals);
            renderFitnessSummary(data.fitness_summary);
            renderActivityDetail(data.activities, selectedIndex);
            if (data.form_chart_data) {
                renderFitnessFatigueChart(data.form_chart_data);
                renderFormChart(data.form_chart_data);
            }
            fetch(`${API_BASE_URL}/api/yearly_progress`)
                .then(response => response.json())
                .then(progressData => {
                    if (Object.keys(progressData).length > 0) {
                        document.getElementById('progression-card').style.display = 'block';
                        renderProgressionChart(progressData);
                    }
                });
            renderHistory(data.activities, selectedIndex);
            lucide.createIcons();
        }
        
        function renderProgressionChart(data) {
            if (progressionChart) { progressionChart.destroy(); }
            const ctx = document.getElementById('progressionChart').getContext('2d');
            const labels = [];
            const startDate = new Date(new Date().getFullYear(), 0, 1);
            for (let i = 0; i < 365; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                labels.push(date);
            }
            const colors = ['#3cb44b', '#4363d8', '#f58231', '#911eb4', '#46f0f0', '#f032e6', '#bcf60c', '#fabebe', '#008080', '#e6beff', '#9a6324', '#e6194b'];
            let colorIndex = 0;
            const datasets = Object.keys(data).sort((a, b) => b - a).map(year => {
                const yearData = data[year];
                const isCurrentYear = year == new Date().getFullYear();
                const color = isCurrentYear ? 'var(--strava-orange)' : colors[colorIndex++ % colors.length];
                return {
                    label: year,
                    data: yearData,
                    borderColor: color,
                    borderWidth: isCurrentYear ? 3 : 1.5,
                    pointRadius: 0,
                    fill: isCurrentYear ? { target: 'origin', above: 'rgba(252, 82, 0, 0.1)' } : false,
                    tension: 0.1
                };
            });
            progressionChart = new Chart(ctx, {
                type: 'line',
                data: { labels: labels, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { type: 'time', time: { unit: 'month', tooltipFormat: 'dd MMM' }, title: { display: false } },
                        y: { title: { display: true, text: 'Distance Cumulative (km)' } }
                    },
                    plugins: { legend: { position: 'top', align: 'start', labels: { usePointStyle: true, boxWidth: 8 } } }
                }
            });
        }
        
        function renderFitnessFatigueChart(data) {
            if (fitnessFatigueChart) { fitnessFatigueChart.destroy(); }
            const ctx = document.getElementById('fitnessFatigueChart').getContext('2d');
            const labels = data.map(d => new Date(d.id));
            const ctlData = data.map(d => d.ctl);
            const atlData = data.map(d => d.atl);
            fitnessFatigueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Fitness (CTL)', data: ctlData, borderColor: 'var(--strava-orange)', backgroundColor: 'rgba(252, 82, 0, 0.1)', borderWidth: 2, tension: 0.4, fill: true, pointRadius: 0 },
                        { label: 'Fatigue (ATL)', data: atlData, borderColor: 'var(--gray-500)', backgroundColor: 'rgba(107, 114, 128, 0.1)', borderWidth: 1.5, tension: 0.4, fill: true, pointRadius: 0 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { x: { type: 'time', time: { unit: 'week' }, grid: { display: false } }, y: { title: { display: true, text: 'Charge d\'entraînement' } } },
                    plugins: { legend: { position: 'bottom', labels: { usePointStyle: true } } }
                }
            });
        }
        
        function renderFormChart(data) {
            if (formChart) { formChart.destroy(); }
            const ctx = document.getElementById('formChart').getContext('2d');
            const labels = data.map(d => new Date(d.id));
            const tsbData = data.map(d => (d.ctl != null && d.atl != null) ? d.ctl - d.atl : null);
            const getFormColor = (value) => {
                if (value === null || isNaN(value)) return 'rgba(107, 114, 128, 0.5)';
                if (value > 5) return 'var(--form-blue)';
                if (value > -10) return 'var(--form-green)';
                if (value > -25) return 'var(--gray-500)';
                return 'var(--form-red)';
            };
            formChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{ label: 'Forme (TSB)', data: tsbData, borderWidth: 2.5, tension: 0.4, pointRadius: 0, segment: { borderColor: ctx => getFormColor(ctx.p1.raw) } }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { x: { type: 'time', time: { unit: 'week' } }, y: { title: { display: true, text: 'Forme (TSB)' } } },
                    plugins: {
                        legend: { display: false },
                        annotation: { annotations: { highRisk: { type: 'box', yMin: -Infinity, yMax: -25, backgroundColor: 'rgba(239, 68, 68, 0.05)', borderColor: 'transparent' }, greyZone: { type: 'box', yMin: -25, yMax: -10, backgroundColor: 'rgba(107, 114, 128, 0.05)', borderColor: 'transparent' }, optimal: { type: 'box', yMin: -10, yMax: 5, backgroundColor: 'rgba(34, 197, 94, 0.05)', borderColor: 'transparent' }, fresh: { type: 'box', yMin: 5, yMax: Infinity, backgroundColor: 'rgba(59, 130, 246, 0.05)', borderColor: 'transparent' } } }
                    }
                }
            });
        }

        function renderGoals(goals) { if (!goals) return; const container = document.getElementById('goals-container'); container.innerHTML = ''; if (goals.weekly) { container.innerHTML += createGoalStat('weeklyGoal', 'Objectif Semaine', goals.weekly); } if (goals.yearly) { container.innerHTML += createGoalStat('yearlyGoal', 'Objectif Annuel', goals.yearly); } if (goals.weekly) weeklyGoalChart = renderGoalChart('weeklyGoalChart', goals.weekly, weeklyGoalChart); if (goals.yearly) yearlyGoalChart = renderGoalChart('yearlyGoalChart', goals.yearly, yearlyGoalChart); }
        function renderFitnessSummary(summary) { const container = document.getElementById('fitness-summary-cards'); if (!summary) return; const getFormClass = (form) => { if (form==null) return ''; if (form > 5) return 'text-blue-500'; if (form > -10) return 'text-green-500'; if (form > -25) return 'text-gray-500'; return 'text-red-500'; }; container.innerHTML = `${createSummaryCard('trending-up', 'Fitness', summary.fitness)}${createSummaryCard('battery-low', 'Fatigue', summary.fatigue)}${createSummaryCard('activity', 'Forme', summary.form, `font-bold ${getFormClass(summary.form)}`)}${createSummaryCard('zap', 'VO2max', summary.vo2max)}`;}
        function renderActivityDetail(activities, index) { const title = document.getElementById('latest-activity-title'); const detailsContainer = document.getElementById('summary-details-container'); if (!activities || !activities.length) return; const activity = activities[index]; title.textContent = index === 0 ? "Dernière Activité" : "Détail de l'Activité"; detailsContainer.innerHTML = `<p class="date">${formatDate(activity.start_date_local)}</p><h3>${activity.name}</h3>${createStatDetail('ruler','Distance',`${(activity.distance/1000).toFixed(2)}`,'km')}${createStatDetail('timer','Durée',formatMovingTime(activity.moving_time))}${createStatDetail('trending-up','Dénivelé',`${activity.total_elevation_gain.toFixed(0)}`,'m')}`; renderMap(activity.map_polyline); const chartCard = document.getElementById('elevation-chart-card'); if (activity.elevation_data) { chartCard.style.display = 'block'; renderChart(activity.elevation_data, 'elevationChart'); } else { chartCard.style.display = 'none'; } }
        
        function renderHistory(activities, selectedIndex) {
            const historyTableBody = document.getElementById('history-table-body');
            if (!activities || !activities.length) return;
            historyTableBody.innerHTML = '';
            activities.forEach((activity, index) => {
                const row = document.createElement('tr');
                if (activity.id === activities[selectedIndex].id) {
                    row.classList.add('selected');
                }
                row.dataset.id = activity.id;
                row.innerHTML = `<td class="strava-orange">${activity.name}</td><td>${(activity.distance / 1000).toFixed(2)} km</td><td>${new Date(activity.start_date_local).toLocaleDateString('fr-FR')}</td>`;
                historyTableBody.appendChild(row);
            });
            historyTableBody.removeEventListener('click', handleHistoryClick);
            historyTableBody.addEventListener('click', handleHistoryClick);
        }

        function handleHistoryClick(event) {
            const clickedRow = event.target.closest('tr');
            if (!clickedRow) return;

            const selectedActivityId = clickedRow.dataset.id;
            const selectedIndex = allActivitiesData.findIndex(act => act.id == selectedActivityId);

            if (allActivitiesData[selectedIndex] && allActivitiesData[selectedIndex].map_polyline) {
                renderActivityDetail(allActivitiesData, selectedIndex);
                renderHistory(allActivitiesData, selectedIndex);
                lucide.createIcons();
                return;
            }

            const detailsContainer = document.getElementById('summary-details-container');
            detailsContainer.innerHTML = `<p>Chargement des détails de l'activité...</p>`;
            document.getElementById('map-container').innerHTML = '';

            fetch(`${API_BASE_URL}/api/activity/${selectedActivityId}`)
                .then(response => response.json())
                .then(activityDetails => {
                    allActivitiesData[selectedIndex] = { ...allActivitiesData[selectedIndex], ...activityDetails };
                    renderActivityDetail(allActivitiesData, selectedIndex);
                    renderHistory(allActivitiesData, selectedIndex);
                    lucide.createIcons();
                })
                .catch(error => {
                    console.error("Erreur lors de la récupération des détails de l'activité:", error);
                    detailsContainer.innerHTML = '<p>Impossible de charger les détails.</p>';
                });
        }

        function createSummaryCard(icon, title, value, valueClass = '') { return `<div class="card summary-card"><h3 class="flex items-center justify-center gap-2"><i data-lucide="${icon}" class="w-4 h-4 text-gray-400"></i>${title}</h3><p class="${valueClass}">${value ?? '-'}</p></div>`; }
        function createGoalStat(idPrefix, title, data) { const remaining = (data.goal - data.current).toFixed(0); const percentage = data.goal > 0 ? ((data.current / data.goal) * 100).toFixed(0) : 0; return `<div class="goal-stat"><div class="goal-chart-container"><canvas id="${idPrefix}Chart"></canvas><div class="goal-percentage">${percentage}%</div></div><div class="goal-details"><h3>${title}</h3><p>${remaining}km à parcourir</p><p class="sub">${data.current.toFixed(0)}km / ${data.goal}km</p></div></div>`;}
        function renderGoalChart(canvasId,data, chartInstance){ if(chartInstance){chartInstance.destroy()} const ctx=document.getElementById(canvasId).getContext("2d"); return new Chart(ctx,{type:"doughnut",data:{datasets:[{data:[data.current,Math.max(0,data.goal-data.current)],backgroundColor:["#fc5200","#d8d9dd"],borderWidth:0,borderRadius:0}]},options:{responsive:!0,maintainAspectRatio:!1,cutout:"75%",plugins:{legend:{display:!1},tooltip:{enabled:!1}}}});}
        function createStatDetail(icon, label, value, unit = '') { return `<div class="stat-item"><div class="stat-label"><i data-lucide="${icon}"></i>${label}</div><div class="stat-value">${value} <span class="unit">${unit}</span></div></div>`; }
        function formatDate(d) { return new Date(d).toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); }
        function formatMovingTime(timeValue) { if (!timeValue) return 'N/A'; const parts=timeValue.split(':').map(Number);if(parts.length===3){const[h,m,s]=parts; if(h===0 && m===0 && s===0) return 'N/A'; if(h>0)return m>0?`${h}h ${m}min`:`${h}h`; if(m>0)return`${m}min ${s}s`; return`${s}s`; } return timeValue; }
        function renderMap(encodedPolyline, zwiftWorld = null){const mapContainer=document.getElementById("map-container");mapContainer.innerHTML='<div id="map"></div>';if(!encodedPolyline){document.getElementById('map').innerHTML='<div style="text-align: center; padding-top: 50px; color: var(--gray-500);">Données de carte non disponibles.</div>';return}try{const map=L.map("map");if(zwiftWorld){L.tileLayer("https://api.zwifthacks.com/zwiftmap/tiles/{world}/{z}/{x}/{y}.png",{world:zwiftWorld,attribution:'&copy; <a href="https://zwiftmap.com">ZwiftMap</a>'}).addTo(map)}else{L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; OSM'}).addTo(map)}const decodedPath=decodePolyline(encodedPolyline);if(decodedPath&&decodedPath.length>0){const polyline=L.polyline(decodedPath,{color:"#fc5200",weight:2}).addTo(map);map.fitBounds(polyline.getBounds().pad(.1))}}catch(e){console.error("Erreur carte:",e)}}
        function renderChart(d, canvasId){if(elevationChart){elevationChart.destroy()}const x=document.getElementById(canvasId).getContext("2d");const g=x.createLinearGradient(0,0,0,250);g.addColorStop(0,"rgba(252,76,2,0.4)"),g.addColorStop(1,"rgba(252,76,2,0)");elevationChart=new Chart(x,{type:"line",data:{labels:d.distance.map(v=>(v/1000).toFixed(1)),datasets:[{label:"Altitude (m)",data:d.altitude,borderColor:"#fc5200",backgroundColor:g,borderWidth:2,pointRadius:0,fill:!0,tension:.3}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{x:{title:{display:true,text:"Distance (km)"}},y:{title:{display:true,text:"Altitude (m)"}}},plugins:{legend:{display:!1}}}});}
        function decodePolyline(e){let l=e.length,i=0,a=0,n=0,r=[];while(i<l){let t,h=0,s=0;do{t=e.charCodeAt(i++)-63,s|=(t&31)<<h,h+=5}while(t>=32);let o=s&1?~(s>>1):s>>1;a+=o,h=0,s=0;do{t=e.charCodeAt(i++)-63,s|=(t&31)<<h,h+=5}while(t>=32);let d=s&1?~(s>>1):s>>1;n+=d,r.push([a*1e-5,n*1e-5])}return r}
    </script>
</body>
</html>